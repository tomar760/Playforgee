// scripts/admin.js

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import {
  getDatabase,
  ref,
  get,
  set,
  onValue
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

import { firebaseConfig } from "../firebase-config.js";

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// ‚úÖ Check if logged-in user is Admin
onAuthStateChanged(auth, (user) => {
  if (user) {
    if (user.email !== "admin@playforge.com") {
      alert("Access denied. Not an admin.");
      window.location.href = "index.html";
    } else {
      loadCurrentRound();
      loadUserActivity();
    }
  } else {
    window.location.href = "index.html";
  }
});

// üéØ Set Winning Color
window.setWinningColor = function () {
  const selectedColor = document.getElementById("adminColor").value;

  set(ref(db, "rounds/current"), {
    roundId: Date.now(),
    winningColor: selectedColor,
    autoGenerated: false
  }).then(() => {
    alert(`Winning color "${selectedColor}" set successfully.`);
  });
}

// üìÖ Load Current Round Info
function loadCurrentRound() {
  const roundRef = ref(db, "rounds/current");

  onValue(roundRef, (snapshot) => {
    if (snapshot.exists()) {
      const round = snapshot.val();
      document.getElementById("currentRound").innerText =
        round.roundId || "Pending...";
    }
  });
}

// üìä Load User Game History (Basic Preview)
function loadUserActivity() {
  const userRef = ref(db, "history");

  onValue(userRef, (snapshot) => {
    const data = snapshot.val();
    const container = document.getElementById("userRecords");
    container.innerHTML = "";

    if (data) {
      for (const uid in data) {
        const logs = data[uid];
        const userDiv = document.createElement("div");
        userDiv.classList.add("user-log");

        let content = `<strong>User ID:</strong> ${uid}<br><ul>`;
        for (const key in logs) {
          const log = logs[key];
          content += `<li>${log.time} ‚Äî Selected: ${log.selected}, Result: ${log.result}, ${log.win ? "‚úÖ Win" : "‚ùå Loss"}</li>`;
        }
        content += "</ul>";

        userDiv.innerHTML = content;
        container.appendChild(userDiv);
      }
    } else {
      container.innerHTML = "No user activity yet.";
    }
  });
}

// üö™ Logout
window.logout = function () {
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
};
